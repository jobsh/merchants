<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.merchant.system.mapper.ContractMapper">
    
    <resultMap type="Contract" id="ContractResult">
        <result property="id"    column="id"    />
        <result property="deptId"    column="dept_id"    />
        <result property="pid"    column="pid"    />
        <result property="rootNum"    column="root_num"    />
        <result property="num"    column="num"    />
        <result property="code"    column="code"    />
        <result property="customerName"    column="customer_name"    />
        <result property="customerId"    column="customer_id"    />
        <result property="customerNum"    column="customer_num"    />
        <result property="customerPhone"    column="customer_phone"    />
        <result property="type"    column="type"    />
        <result property="produce"    column="produce"    />
        <result property="dianmianName"    column="dianmian_name"    />
        <result property="dianmianNum"    column="dianmian_num"    />
        <result property="dianmianProvince"    column="dianmian_province"    />
        <result property="dianmianCity"    column="dianmian_city"    />
        <result property="dianmianDistrict"    column="dianmian_district"    />
        <result property="dianmianAddress"    column="dianmian_address"    />
        <result property="dianmianLongitude"    column="dianmian_longitude"    />
        <result property="dianmianLatitude"    column="dianmian_latitude"    />
        <result property="guarantee"    column="guarantee"    />
        <result property="fee"    column="fee"    />
        <result property="operation"    column="operation"    />
        <result property="managerId"    column="manager_id"    />
        <result property="manager"    column="manager"    />
        <result property="signDate"    column="sign_date"    />
        <result property="signUserId"    column="sign_user_id"    />
        <result property="signUser"    column="sign_user"    />
        <result property="beginDate"    column="begin_date"    />
        <result property="endDate"    column="end_date"    />
        <result property="terminateDate"    column="terminate_date"    />
        <result property="status"    column="status"    />
        <result property="checkStatus"    column="check_status"    />
        <result property="checkDate"    column="check_date"    />
        <result property="file"    column="file"    />
        <result property="terminateFile"    column="terminate_file"    />
        <result property="imgs"    column="imgs"    />
        <result property="createBy"    column="create_by"    />
        <result property="remark"    column="remark"    />
        <result property="deptName"    column="dept_name"    />
    </resultMap>

    <sql id="selectContractVo">
        select
            biz_contract.id, biz_contract.dept_id, biz_contract.pid, biz_contract.root_num, biz_contract.num, biz_contract.code, customer_name, biz_contract.customer_id, biz_contract.customer_num, biz_contract.customer_phone, biz_contract.type, biz_contract.produce,
            biz_contract.dianmian_name, biz_contract.dianmian_num, biz_contract.dianmian_province, biz_contract.dianmian_city, biz_contract.dianmian_district, biz_contract.dianmian_address, biz_contract.dianmian_longitude, biz_contract.dianmian_latitude,
            biz_contract.guarantee, biz_contract.fee, biz_contract.operation, biz_contract.manager_id, biz_contract.manager, biz_contract.sign_date, biz_contract.sign_user_id,
            biz_contract.sign_user, biz_contract.begin_date, biz_contract.end_date,biz_contract.terminate_date, biz_contract.status, biz_contract.check_status,biz_contract.check_date, biz_contract.create_by, biz_contract.remark, biz_contract.file, biz_contract.terminate_file, biz_contract.imgs,
            d.dept_name
        from
            biz_contract
        left join
            sys_user u
        on
            biz_contract.manager_id = u.id
        left join
            sys_dept d
        on
            u.dept_id = d.id
    </sql>

    <select id="selectContractList" parameterType="ContractBO" resultMap="ContractResult">
        <include refid="selectContractVo"/>
        <where>
            <if test="deptId != null and deptId != 0">
                AND (u.dept_id = #{deptId} OR u.dept_id IN ( SELECT t.id FROM sys_dept t WHERE find_in_set(#{deptId}, ancestors) ))
            </if>
            <if test="customerId !=  null  and customerId != ''">and customer_id = #{customerId}</if>
            <if test="managerId !=  null  and managerId != ''">and manager_id = #{managerId}</if>
            <if test="num != null  and num != ''"> and biz_contract.num  like concat('%', #{num}, '%')</if>
            <if test="customerName != null  and customerName != ''"> and biz_contract.customer_name like concat('%', #{customerName}, '%')</if>
            <if test="customerPhone != null  and customerPhone != ''"> and biz_contract.customer_phone = #{customerPhone}</if>
            <if test="type != null  and type != ''"> and biz_contract.type = #{type}</if>
            <if test="produce != null  and produce != ''"> and biz_contract.produce = #{produce}</if>
            <if test="operation != null  and operation != ''"> and biz_contract.operation = #{operation}</if>
            <if test="signDateStart != null  and signDateStart != ''">and biz_contract.sign_date &gt;= #{signDateStart}</if>
            <if test="signDateEnd != null  and signDateEnd != ''">and biz_contract.sign_date &lt;= #{signDateEnd}</if>
            <if test="beginDateStart != null  and beginDateStart != ''">and biz_contract.begin_date &gt;= #{beginDateStart}</if>
            <if test="beginDateEnd != null  and beginDateEnd != ''">and biz_contract.begin_date &lt;= #{beginDateEnd}</if>
            <if test="checkDateStart != null  and checkDateStart != ''">and biz_contract.check_date &gt;= #{checkDateStart}</if>
            <if test="checkDateEnd != null  and checkDateEnd != ''">and biz_contract.check_date &lt;= #{checkDateEnd}</if>
            <if test="endDateStart != null  and endDateStart != ''">and biz_contract.end_date &gt;= #{endDateStart}</if>
            <if test="endDateEnd != null  and endDateEnd != ''">and biz_contract.end_date &lt;= #{endDateEnd}</if>
            <if test="status != null  and status != ''"> and biz_contract.status = #{status}</if>
            <if test="checkStatus = null  and checkStatus = ''"> and biz_contract.check_status &lt;&gt; '2'</if>
            <if test="checkStatus != null  and checkStatus != ''"> and biz_contract.check_status = #{checkStatus}</if>
            <if test="keywords != null and keywords != ''">and (
                instr(biz_contract.customer_name, #{keywords}) +
                instr(biz_contract.customer_phone, #{keywords}) +
                instr(biz_contract.num, #{keywords})
                ) > 0</if>
            <!-- 数据范围过滤 -->
            ${params.dataScope}
        </where>
        order by biz_contract.sign_date desc
    </select>

    <select id="selectContractById" parameterType="Integer" resultMap="ContractResult">
        <include refid="selectContractVo"/>
        where biz_contract.id = #{id}
    </select>

    <select id="selectContractByRootNum" parameterType="String" resultMap="ContractResult">
        <include refid="selectContractVo"/>
        where biz_contract.root_num = #{rootNum}
    </select>

    <select id="selectContractByNum" parameterType="String" resultMap="ContractResult">
        <include refid="selectContractVo"/>
        where biz_contract.num = #{num}
    </select>

    <select id="countContractByNum" parameterType="String" resultType="Integer">
        select count(1) from biz_contract
        where biz_contract.num = #{num}
    </select>
    <select id="selectContractByIds" resultType="com.merchant.system.domain.Contract" parameterType="Integer">
        select * from biz_contract where biz_contract.id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>


    <insert id="insertContract" parameterType="AddContractBO" useGeneratedKeys="true" keyProperty="id">
        insert into biz_contract
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="deptId != null and deptId != ''">dept_id,</if>
            <if test="num != null and num != ''">num,</if>
            <if test="rootNum != null and rootNum != ''">root_num,</if>
            <if test="customerName != null and customerName != ''">customer_name,</if>
            <if test="customerId != null">customer_id,</if>
            <if test="customerNum != null and customerNum != ''">customer_num,</if>
            <if test="code != null and code != ''">code,</if>
            <if test="customerPhone != null and customerPhone != ''">customer_phone,</if>
            <if test="type != null and type != ''">type,</if>
            <if test="produce != null and produce != ''">produce,</if>
            <if test="dianmianName != null and dianmianName != ''">dianmian_name,</if>
            <if test="dianmianNum != null and dianmianNum != ''">dianmian_num,</if>
            <if test="dianmianProvince != null and dianmianProvince != ''">dianmian_province,</if>
            <if test="dianmianCity != null and dianmianCity != ''">dianmian_city,</if>
            <if test="dianmianDistrict != null and dianmianDistrict != ''">dianmian_district,</if>
            <if test="dianmianAddress != null and dianmianAddress != ''">dianmian_address,</if>
            <if test="dianmianLongitude != null and dianmianLongitude != ''">dianmian_longitude,</if>
            <if test="dianmianLatitude != null and dianmianLatitude != ''">dianmian_latitude,</if>
            <if test="guarantee != null">guarantee,</if>
            <if test="fee != null and fee != ''">fee,</if>
            <if test="operation != null and operation != ''">operation,</if>
            <if test="managerId != null">manager_id,</if>
            <if test="manager != null and manager != ''">manager,</if>
            <if test="signDate != null">sign_date,</if>
            <if test="signUserId != null">sign_user_id,</if>
            <if test="signUser != null and signUser != ''">sign_user,</if>
            <if test="beginDate != null">begin_date,</if>
            <if test="endDate != null and endDate != ''">end_date,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            <if test="remark != null and remark != ''">remark,</if>
            <if test="file != null and file != ''">file,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="deptId != null and deptId != ''">#{deptId},</if>
            <if test="num != null and num != ''">#{num},</if>
            <if test="rootNum != null and rootNum != ''">#{rootNum},</if>
            <if test="customerName != null and customerName != ''">#{customerName},</if>
            <if test="customerId != null">#{customerId},</if>
            <if test="customerNum != null and customerNum != ''">#{customerNum},</if>
            <if test="code != null and code != ''">#{code},</if>
            <if test="customerPhone != null and customerPhone != ''">#{customerPhone},</if>
            <if test="type != null and type != ''">#{type},</if>
            <if test="produce != null and produce != ''">#{produce},</if>
            <if test="dianmianName != null and dianmianName != ''">#{dianmianName},</if>
            <if test="dianmianNum != null and dianmianName != ''">#{dianmianNum},</if>
            <if test="dianmianProvince != null and dianmianProvince != ''">#{dianmianProvince},</if>
            <if test="dianmianCity != null and dianmianCity != ''">#{dianmianCity},</if>
            <if test="dianmianDistrict != null and dianmianDistrict != ''">#{dianmianDistrict},</if>
            <if test="dianmianAddress != null and dianmianAddress != ''">#{dianmianAddress},</if>
            <if test="dianmianLongitude != null and dianmianLongitude != ''">#{dianmianLongitude},</if>
            <if test="dianmianLatitude != null and dianmianLatitude != ''">#{dianmianLatitude},</if>
            <if test="guarantee != null">#{guarantee},</if>
            <if test="fee != null">#{fee},</if>
            <if test="operation != null and operation != ''">#{operation},</if>
            <if test="managerId != null">#{managerId},</if>
            <if test="manager != null and manager != ''">#{manager},</if>
            <if test="signDate != null">#{signDate},</if>
            <if test="signUserId != null">#{signUserId},</if>
            <if test="signUser != null and signUser != ''">#{signUser},</if>
            <if test="beginDate != null">#{beginDate},</if>
            <if test="endDate != null and endDate != ''">#{endDate},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            <if test="remark != null and remark != ''">#{remark},</if>
            <if test="file != null and file != ''">#{file},</if>
         </trim>
    </insert>

    <update id="updateContract" parameterType="ContractBO">
        update biz_contract
        <trim prefix="SET" suffixOverrides=",">
            <if test="deptId != null and deptId != ''">dept_id = #{deptId},</if>
            <if test="num != null and num != ''">num = #{num},</if>
            <if test="rootNum != null and rootNum != ''">root_num = #{rootNum},</if>
            <if test="customerName != null and customerName != ''">customer_name = #{customerName},</if>
            <if test="customerId != null">customer_id = #{customerId},</if>
            <if test="customerPhone != null and customerPhone != ''">customer_phone = #{customerPhone},</if>
            <if test="type != null and type != ''">type = #{type},</if>
            <if test="produce != null and produce != ''">produce = #{produce},</if>
            <if test="dianmianName != null and dianmianName != ''">dianmian_name = #{dianmianName},</if>
            <if test="dianmianNum != null">dianmian_num = #{dianmianNum},</if>
            <if test="dianmianProvince != null and dianmianProvince != ''">dianmian_province = #{dianmianProvince},</if>
            <if test="dianmianCity != null and dianmianCity != ''">dianmian_city = #{dianmianCity},</if>
            <if test="dianmianDistrict != null and dianmianDistrict != ''">dianmian_district = #{dianmianDistrict},</if>
            <if test="dianmianAddress != null and dianmianAddress != ''">dianmian_address = #{dianmianAddress},</if>
            <if test="dianmianLongitude != null and dianmianLongitude != ''">dianmian_longitude = #{dianmianLongitude},</if>
            <if test="dianmianLatitude != null and dianmianLatitude != ''">dianmian_latitude = #{dianmianLatitude},</if>
            <if test="guarantee != null">guarantee = #{guarantee},</if>
            <if test="fee != null">fee = #{fee},</if>
            <if test="operation != null and operation != ''">operation = #{operation},</if>
            <if test="managerId != null">manager_id = #{managerId},</if>
            <if test="manager != null and manager != ''">manager = #{manager},</if>
            <if test="signDate != null">sign_date = #{signDate},</if>
            <if test="signUserId != null">sign_user_id = #{signUserId},</if>
            <if test="signUser != null and signUser != ''">sign_user = #{signUser},</if>
            <if test="checkStatus != null and checkStatus != ''">check_status = #{checkStatus},</if>
            <if test="beginDate != null">begin_date = #{beginDate},</if>
            <if test="endDate != null and endDate != ''">end_date = #{endDate},</if>
            <if test="terminateDate != null and terminateDate != ''">terminate_date = #{terminateDate},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="createBy != null and createBy != ''">create_by = #{createBy},</if>
            <if test="remark != null and remark != ''">remark = #{remark},</if>
            <if test="file != null and file != ''">file = #{file},</if>
            <if test="terminateFile != null and terminateFile != ''">terminate_file = #{terminateFile},</if>
            <if test="imgs != null and imgs != ''">imgs = #{imgs},</if>
        </trim>
        where biz_contract.id = #{id}
    </update>
    <update id="autoExpire" parameterType="ContractBO">
        update
            biz_contract bc
        set
            bc.status = #{status}
        where
            bc.end_date &lt;= now() and bc.status = '0' -- 有效执行中
    </update>
    <update id="autoBegin" parameterType="ContractBO">
        update
            biz_contract bc
        set
            bc.status = #{status}
        where
            bc.begin_date &lt;= now() and bc.end_date &gt;= now() and bc.status = '1' -- 有效未执行
    </update>

    <delete id="deleteContractById" parameterType="Integer">
        delete from biz_contract where biz_contract.id = #{id}
    </delete>

    <delete id="deleteContractByIds" parameterType="Integer">
        delete from biz_contract where biz_contract.id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
</mapper>